---
title: 网络
categories: 
- 计算机网络
---

# TCP/IP四层和OSI七层
四层：网络接口层 网络层 传输层 应用层
七层：物理层 数据链路层 网络层 传输层 会话层 表示层 应用层

## TCP
TCP 是面向连接的、可靠的、基于字节流的传输层通信协议。
TCP是一个工作在传输层的可靠数据传输的服务，它能保证接收端收到的网络包是**无损坏**、**无间隔**、**非冗余**和**按序**的.
面向连接：TCP是1-1的连接，不像UDP可以一对多、多对多、多对一
可靠：网络出现变化，保证报文一定到达接收端
字节流：消息会被分片，不知道边界则无法有效读出消息，报文通过序列号控制有序

1. TCP和UDP的区别：
    + TCP是有连接的，UDP是无连接的
    + TCP是一对一的，UDP可以一对多、多对多、多对一
    + TCP是可靠的，发出的报文是有确认机制的，UDP是尽最大努力交付的，不确认
    + TCP有拥塞控制和流量控制机制，保证传输的安全，UDP没有，网络的拥塞程度不影响其发送速率
    + TCP首部是20(default)-60(4Byte * 10)个字节，UDP首部8个字节，固定不变
    + TCP是流式传输，没有边界但保证顺序、可靠，UDP按包发送，有边界，但可能丢包乱序
    + TCP的数据如果大于MSS，在传输层分片，接收方传输层组装，UDP数据大于MTU，在IP层分片，在接收方IP层组装
2. 网络层会分片，为什么TCP要在传输层分片：
    网络层得分片没有超时重传机制，导致IP层的分片一个丢了，所有都要重传，低效。
    使用TCP在传输层就分片，保证IP层无需分片，由传输层负责超时重传等任务，更高效。
3. 保证可靠传输
    + **慢开始**：在主机刚刚开始发送报文段时可**先将拥塞窗口cwnd设置为一个最大报文段MSS的数值**。在**每收到一个对新的报文段的确认**后，将**拥塞窗口增加至多一个MSS的数值**。用这样的方法逐步增大发送端的拥塞窗口cwnd，可以分组注入到网络的速率更加合理。
    + **拥塞避免**：当**拥塞窗口值大于慢开始门限**时，**停止使用慢开始**算法而**改用拥塞避免算法**。拥塞避免算法使发送的**拥塞窗口每经过一个往返时延RTT就增加一个MSS的大小**。
    + **快重传**：发送端只要一连**收到三个重复的ACK**(当TCP的接收方收到了序号大于它本身期待序号的分组时，就会发送冗余的ACK)即可断定有分组丢失了，就应该立即重传丢手的报文段而不必继续等待为该报文段设置的重传计时器的超时。
    + **快恢复**：当发送端收到连续三个重复的ACK时，就重新设置慢开始门限 ssthresh,与慢开始不同之处是拥塞窗口 cwnd 不是设置为 1，而是设置为ssthresh,若收到的重复的AVK为n个（n>3），则将cwnd设置为ssthresh,若发送窗口值还容许发送报文段，就按拥塞避免算法继续发送报文段。若收到了确认新的报文段的ACK，就将cwnd缩小到ssthresh
    + **乘法减小**：是指不论在慢开始阶段还是拥塞避免阶段，只要出现一次超时（即出现一次网络拥塞），就把慢开始门限值 ssthresh 设置为当前的拥塞窗口值乘以 0.5。当网络频繁出现拥塞时，ssthresh 值就下降得很快，以大大减少注入到网络中的分组数。
    + **加法增大**：是指执行拥塞避免算法后，在收到对所有报文段的确认后（即经过一个往返时间），就把拥塞窗口 cwnd增加一个 MSS 大小，使拥塞窗口缓慢增大，以防止网络过早出现拥塞。

### TCP报文格式
{% asset_img tcp_pack.png Https Connection %}

### TCP连接与断开
#### TCP建立连接
{% asset_img tcp_established.png Https Connection %}

#### TCP为什么是三次握手
保证双方具有接收和发送的能力

1. 阻止重复历史连接的初始化：syn阻塞了，syn重发但阻塞，接收端和用旧的syn建立了连接
2. 同步双方的初始序列号
3. 避免资源浪费：syn丢了，重复发syn，导致重复建立多个无效冗余连接



# HTTP
域名解析 —> 与服务器建立TCP连接 —> 发起HTTP请求 —> 服务器响应HTTP请求，浏览器得到html代码 —> 浏览器解析html代码，并请求html代码中的资源（如js、css、图片） —> 浏览器对页面进行渲染呈现给用户

## DNS域名解析
1. 检查浏览器DNS缓存
2. 本地电脑检查host文件配置
3. 用户向本地DNS服务器发起DNS解析请求
4. 本地DNS服务器向根DNS服务器发起域名解析请求
5. 根DNS给本地DNS返回顶级DNS服务器地址
6. 本地DNS向顶级DNS服务器发起解析请求
7. 顶级DNS给本地DNS返回Name Server服务器地址
8. 本地DNS向Name Server服务器发起解析请求
9. Name Server给本地DNS返回正确的DNS解析结果
10. 本地DNS给本地电脑返回正确的DNS解析结果

DNS存在迭代和递归两种方式，上述就属于迭代查询，本地电脑发起请求后，由本地DNS不断与各级DNS服务器进行查询。
递归查询是指，每查询到一级域名，都向本地电脑返回，本地电脑再针对返回的每一级DNS服务器的地址发起DNS解析请求。
简而言之，迭代方式种本地电脑只需要发起一次解析请求，递归方式本地电脑可能发起多次DNS解析请求。


## 请求消息
1. 请求行（Request Line）：
    方法：如 GET、POST、PUT、DELETE等，指定要执行的操作。
    请求 URI（统一资源标识符）：请求的资源路径，通常包括主机名、端口号（如果非默认）、路径和查询字符串。
    HTTP 版本：如 HTTP/1.1 或 HTTP/2。
    请求行的格式示例：GET /index.html HTTP/1.1
2. 请求头（Request Headers）：
    包含了客户端环境信息、请求体的大小（如果有）、客户端支持的压缩类型等。
    常见的请求头包括Host、User-Agent、Accept、Accept-Encoding、Content-Length等。
3. 空行：
    请求头和请求体之间的分隔符，表示请求头的结束。
4. 请求体（可选）：
    在某些类型的HTTP请求（如 POST 和 PUT）中，请求体包含要发送给服务器的数据。

## 响应消息
1. 状态行（Status Line）：
    HTTP 版本：与请求消息中的版本相匹配。
    状态码：三位数，表示请求的处理结果，如 200 表示成功，404 表示未找到资源。
    状态信息：状态码的简短描述。
    状态行的格式示例：HTTP/1.1 200 OK
2. 响应头（Response Headers）：
    包含了服务器环境信息、响应体的大小、服务器支持的压缩类型等。
    常见的响应头包括Content-Type、Content-Length、Server、Set-Cookie等。
3. 空行：
    响应头和响应体之间的分隔符，表示响应头的结束。
4. 响应体（可选）：
    包含服务器返回的数据，如请求的网页内容、图片、JSON数据等。

## 版本区别
### HTTP1.0
HTTP协议的第二个版本，第一个在通讯中指定版本号的HTTP协议版本

HTTP 1.0 浏览器与服务<b>器只保持短暂的连接，每次请求都需要与服务器建立一个TCP连接</b>

服务器完成请求处理后立即断开TCP连接，服务器不跟踪每个客户也不记录过去的请求

简单来讲，每次与服务器交互，都需要新开一个连接

例如，解析html文件，当发现文件中存在资源文件的时候，这时候又创建单独的链接

最终导致，<b>一个html文件的访问包含了多次的请求和响应，每次请求都需要创建连接、关系连接</b>

这种形式明显造成了性能上的缺陷

如果需要建立长连接，需要设置一个非标准的Connection字段 Connection: keep-alive

### HTTP1.1
1. 在HTTP1.1中，<b>默认支持长连接（Connection: keep-alive）</b>，即在一个TCP连接上可以传送多个HTTP请求和响应，减少了建立和关闭连接的消耗和延迟

    建立一次连接，多次请求均由这个连接完成

    这样，在加载html文件的时候，文件中多个请求和响应就可以在一个连接中传输

2. HTTP 1.1还允许客户端<b>不用等待上一次请求结果返回，就可以发出下一次请求</b>，但<b>服务器端必须按照接收到客户端请求的先后顺序依次回送响应结果</b>，以保证客户端能够区分出每次请求的响应内容，这样也显著地减少了整个下载过程所需要的时间

3. HTTP1.1在HTTP1.0的基础上，<b>增加更多的请求头和响应头来完善的功能</b>，如下：

    引入了更多的缓存控制策略，如If-Unmodified-Since, If-Match, If-None-Match等缓存头来控制缓存策略
    引入range，允许值请求资源某个部分
    引入host，实现了在一台WEB服务器上可以在同一个IP地址和端口号上使用不同的主机名来创建多个虚拟WEB站点
    并且还添加了其他的请求方法：put、delete、options...

### HTTP2.0
而HTTP2.0在相比之前版本，性能上有很大的提升，如添加了一个特性：

+ 多路复用
+ 二进制分帧
+ 首部压缩
+ 服务器推送
1. 多路复用
    HTTP/2 复用TCP连接，在一个连接里，<b>客户端和浏览器都可以同时发送多个请求或回应，而且不用按照顺序一一对应，这样就避免了”队头堵塞”</b>

2. 二进制分帧

    帧是HTTP2通信中最小单位信息

    HTTP/2 采用二进制格式传输数据，而非 HTTP 1.x的文本格式，解析起来更高效

    将请求和响应数据分割为更小的帧，并且它们采用二进制编码

    HTTP2中，同域名下所有通信都在单个连接上完成，该连接可以承载任意数量的双向数据流

    每个数据流都以消息的形式发送，而消息又由一个或多个帧组成。多个帧之间可以乱序发送，根据帧首部的流标识可以重新组装，这也是多路复用同时发送数据的实现条件

3. 首部压缩
    HTTP/2在客户端和服务器端<b>使用“首部表”来跟踪和存储之前发送的键值对，对于相同的数据，不再通过每次请求和响应发送</b>

    首部表在HTTP/2的连接存续期内始终存在，由客户端和服务器共同渐进地更新

4. 服务器推送
    HTTP2引入服务器推送，<b>允许服务端推送资源给客户端</b>

    服务器会顺便把一些客户端需要的资源一起推送到客户端，如在响应一个页面请求中，就可以随同页面的其它资源

    免得客户端再次创建连接发送请求到服务器端获取

    这种方式非常合适加载静态资源

# Https

{% asset_img Https.png Https Connection %}


# 参考
1. [DNS解析全过程](https://blog.csdn.net/bangshao1989/article/details/121913780)
2. [两种DNS解析方式](https://wenku.csdn.net/answer/76d3230357ff42e6a5aa4ef759f507c2#)
3. [HTTPS](https://segmentfault.com/a/1190000021494676)
4. [常见面试题](https://xiaolincoding.com/network/2_http/http_interview.html)
