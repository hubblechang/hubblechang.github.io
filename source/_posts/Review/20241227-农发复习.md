---
title: 20241227-农发复习
categories:
  - 复习
---
# Spring事务
在 Spring Boot 中，事务管理是确保数据一致性和完整性的重要机制。Spring 提供了两种主要的事务管理方式：编程式事务管理和声明式事务管理。

**1. 编程式事务管理：**

编程式事务管理要求开发者在代码中手动控制事务的开始、提交和回滚。这通常涉及使用 `PlatformTransactionManager` 或 `TransactionTemplate`。然而，这种方式会使业务代码与事务管理代码混杂，增加代码复杂度。因此，Spring 更推荐使用声明式事务管理。

**2. 声明式事务管理：**

声明式事务管理通过使用 `@Transactional` 注解，将事务管理从业务代码中分离出来，简化了开发过程。这种方式基于 AOP（面向切面编程）实现，允许在方法执行前后自动处理事务。
**使用 `@Transactional` 注解：**
- **应用范围：**
    - `@Transactional` 注解通常应用于 `public` 方法。在非 `public` 方法上使用可能无法生效，因为 Spring 的代理机制默认只代理 `public` 方法。     
- **回滚规则：**
    
    - 默认情况下，Spring 仅对未检查异常（继承自 `RuntimeException` 的异常）或 `Error` 进行回滚。如果希望对其他类型的异常（例如受检查异常）进行回滚，需要在注解中指定：
        
```
	@Transactional(rollbackFor = Exception.class) 
	public void someMethod() { 
		// 业务逻辑
	}
```
        
- **事务传播行为：**
    
    - `@Transactional` 提供了多种传播行为（Propagation），用于定义事务方法相互调用时的事务边界。例如，`REQUIRED` 表示如果当前存在事务，则加入该事务；如果不存在，则创建一个新的事务。
        
```
	@Transactional(propagation = Propagation.REQUIRED) 
	public void someMethod() { 
	    // 业务逻辑
	}
```
        
- **隔离级别：**
    
    - 可以通过 `isolation` 属性设置事务的隔离级别，例如 `Isolation.READ_COMMITTED`，以控制并发事务之间的相互影响。
```
	@Transactional(isolation = Isolation.READ_COMMITTED) 
	public void someMethod() { 
		// 业务逻辑
	 }
```
        

**注意事项：**

- **内部方法调用：**
    - 如果在同一个类中调用另一个带有 `@Transactional` 注解的方法，事务可能不会生效。这是因为内部方法调用不会触发代理机制。为避免此问题，可以将事务性方法提取到独立的服务类中。
- **事务管理器配置：**
    - Spring Boot 会根据项目中的数据源自动配置合适的事务管理器。在大多数情况下，无需手动配置；但在多数据源或特定需求下，可能需要自定义事务管理器。
通过正确使用 `@Transactional` 注解，Spring Boot 能够简化事务管理，确保数据操作的原子性和一致性。

# try-catch如何提高效率
在编写代码时，合理使用 `try-catch` 结构对于处理异常至关重要。然而，不当或过度使用可能会影响性能。以下是提高 `try-catch` 使用效率的建议：

1. **避免将 `try-catch` 用于控制正常流程：**
    - `try-catch` 应用于异常处理，而非控制正常的业务逻辑。将其用于正常流程可能导致性能下降。
2. **减少在循环中使用 `try-catch`：**
    - 在循环内部使用 `try-catch` 会增加性能开销。应尽量将可能抛出异常的代码移出循环，或在循环外部进行异常处理。
3. **优化异常处理逻辑：**
    - 确保在 `catch` 块中执行的操作高效，避免耗时的操作，如数据库查询或网络请求。保持异常处理逻辑的简洁明了，有助于提高代码的可读性和性能。
4. **使用自定义异常：**
    - 在需要频繁抛出异常的情况下，考虑使用自定义异常类。通过减少堆栈跟踪信息的收集或优化异常对象的创建过程，可以降低性能消耗。
5. **避免过度使用 `try-catch`：**
    - 过多的 `try-catch` 块可能增加代码复杂性和维护成本。应在必要时使用，并确保其有实际意义。
6. **在可能的情况下，使用条件检查替代：**
    - 在某些情况下，使用条件语句（如 `if-else`）检查可能的错误条件，比依赖异常处理更高效。

通过遵循上述建议，可以在有效处理异常的同时，减少 `try-catch` 对程序性能的影响。

# 慢查询优化
优化慢查询是提升数据库性能的关键。以下是一些常见的优化方法：

1. **启用慢查询日志：**
    - 通过开启 MySQL 的慢查询日志，记录执行时间较长的 SQL 语句，便于定位性能瓶颈。
2. **使用 EXPLAIN 分析查询：**
    - 利用 `EXPLAIN` 关键字模拟优化器执行 SQL 查询，分析查询的执行计划，判断是否使用了索引，以及各个表的读取顺序等。
3. **优化索引：**
    - 为查询涉及的字段添加合适的索引，特别是 `WHERE`、`ORDER BY`、`GROUP BY` 等子句中的字段。
    - 避免对区分度低的列建立索引，因为这可能不会带来显著的性能提升。
4. **避免全表扫描：**
    - 确保查询条件能够有效利用索引，避免在查询条件中对索引字段进行函数或运算操作，这会导致索引失效，进而引发全表扫描。
5. **优化查询语句：**
    - 避免使用 `SELECT *`，只查询必要的字段，减少数据传输量。
    - 在可能的情况下，使用 `UNION ALL` 替代 `UNION`，因为前者不进行重复数据检查，性能更高。
6. **优化表结构：**
    - 对于数据量巨大的表，考虑进行分区或分表处理，减少单表的数据量，提高查询效率。
7. **缓存频繁查询的数据：**
    - 对于经常被查询且不经常变化的数据，考虑使用缓存机制，减少数据库的读取压力。
8. **定期维护数据库：**
    - 定期执行数据库的分析和优化操作，如更新统计信息、重建索引等，确保查询优化器能够生成高效的执行计划。
通过以上方法，可以有效地优化慢查询，提升数据库的整体性能。